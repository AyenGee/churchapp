<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Event - Sunday School Records</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <nav class="bg-[#1F2839] text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center h-16">
                <a href="events.html" class="mr-4">‚Üê Back</a>
                <h1 class="text-xl font-bold" id="pageTitle">üéâ Add Event</h1>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <form id="eventForm" class="bg-white rounded-lg shadow-lg p-6 space-y-6">
            <!-- Event Name & Type -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Event Name *</label>
                    <input type="text" id="eventName" name="eventName" required placeholder="e.g., Summer Camp 2024"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Event Type *</label>
                    <select id="eventType" name="eventType" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select type</option>
                        <option value="Outing">Outing</option>
                        <option value="Camp">Camp</option>
                        <option value="Concert">Concert</option>
                        <option value="Conference">Conference</option>
                        <option value="Workshop">Workshop</option>
                        <option value="Special Service">Special Service</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
            </div>

            <!-- Dates -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Start Date *</label>
                    <input type="date" id="startDate" name="startDate" required
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">End Date (optional)</label>
                    <input type="date" id="endDate" name="endDate"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <!-- Location -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                <input type="text" id="location" name="location" placeholder="e.g., Church Hall, Park Name"
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Teachers -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Teachers/Leaders</label>
                <div id="teachersList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-md p-2">
                    <!-- Teachers checkboxes will be loaded here -->
                </div>
            </div>

            <!-- Attendance -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Expected/Actual Attendance</label>
                <input type="text" id="childSearch" placeholder="Search children..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    oninput="filterChildren(this.value)">
                <div id="childrenList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-300 rounded-md p-2">
                    <!-- Children checkboxes will be loaded here -->
                </div>
            </div>

            <!-- Notes & Outcomes -->
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="Event details, schedule, special instructions..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Outcomes (fill after event)</label>
                    <textarea id="outcomes" name="outcomes" rows="4" placeholder="What was accomplished, lessons learned..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
            </div>

            <!-- Status -->
            <div class="flex items-center">
                <label class="flex items-center">
                    <input type="checkbox" id="isCompleted" name="isCompleted" class="mr-2">
                    <span class="text-sm font-medium text-gray-700">Mark as completed</span>
                </label>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t">
                <button type="submit" 
                    class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 font-medium">
                    Save Event
                </button>
                <button type="button" onclick="window.location.href='events.html'"
                    class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        const isEdit = !!eventId;

        if (isEdit) {
            document.getElementById('pageTitle').textContent = 'üéâ Edit Event';
        }

        let allChildren = [];
        let allTeachers = [];
        let existingEvent = null;

        async function loadChildrenAndTeachers() {
            try {
                [allChildren, allTeachers] = await Promise.all([
                    childrenAPI.getAll('?active=true'),
                    teachersAPI.getAll('?active=true')
                ]);

                renderChildren(allChildren);
                renderTeachers(allTeachers);

                // If editing, load event data and pre-select checkboxes
                if (isEdit) {
                    await loadEventData();
                }
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load data', 'error');
            }
        }

        async function loadEventData() {
            try {
                existingEvent = await eventsAPI.getById(eventId);
                
                document.getElementById('eventName').value = existingEvent.eventName;
                document.getElementById('eventType').value = existingEvent.eventType;
                document.getElementById('startDate').value = formatDateForInput(existingEvent.startDate);
                if (existingEvent.endDate) {
                    document.getElementById('endDate').value = formatDateForInput(existingEvent.endDate);
                }
                document.getElementById('location').value = existingEvent.location || '';
                document.getElementById('notes').value = existingEvent.notes || '';
                document.getElementById('outcomes').value = existingEvent.outcomes || '';
                document.getElementById('isCompleted').checked = existingEvent.isCompleted;

                // Pre-select children and teachers
                if (existingEvent.attendance && existingEvent.attendance.length > 0) {
                    existingEvent.attendance.forEach(childId => {
                        const checkbox = document.querySelector(`input[name="attendance"][value="${childId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }

                if (existingEvent.teachers && existingEvent.teachers.length > 0) {
                    existingEvent.teachers.forEach(teacherId => {
                        const checkbox = document.querySelector(`input[name="teachers"][value="${teacherId}"]`);
                        if (checkbox) checkbox.checked = true;
                    });
                }
            } catch (error) {
                console.error('Error loading event:', error);
                showNotification('Failed to load event data', 'error');
            }
        }

        function renderChildren(children) {
            const container = document.getElementById('childrenList');
            if (children.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No children found.</p>';
                return;
            }
            container.innerHTML = children.map(child => `
                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" name="attendance" value="${child._id}" class="mr-2">
                    <span class="text-sm">${child.name} (${child.class})</span>
                </label>
            `).join('');
        }

        function renderTeachers(teachers) {
            const container = document.getElementById('teachersList');
            if (teachers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No teachers found.</p>';
                return;
            }
            container.innerHTML = teachers.map(teacher => `
                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" name="teachers" value="${teacher._id}" class="mr-2">
                    <span class="text-sm">${teacher.name} (${teacher.role})</span>
                </label>
            `).join('');
        }

        function filterChildren(searchTerm) {
            const filtered = allChildren.filter(child => 
                child.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                child.class.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderChildren(filtered);
        }

        // Handle form submission
        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const attendanceCheckboxes = document.querySelectorAll('input[name="attendance"]:checked');
            const teachersCheckboxes = document.querySelectorAll('input[name="teachers"]:checked');

            const eventData = {
                eventName: formData.get('eventName'),
                eventType: formData.get('eventType'),
                startDate: formData.get('startDate'),
                endDate: formData.get('endDate') || undefined,
                location: formData.get('location') || undefined,
                attendance: Array.from(attendanceCheckboxes).map(cb => cb.value),
                teachers: Array.from(teachersCheckboxes).map(cb => cb.value),
                notes: formData.get('notes') || undefined,
                outcomes: formData.get('outcomes') || undefined,
                isCompleted: document.getElementById('isCompleted').checked
            };

            try {
                if (isEdit) {
                    await eventsAPI.update(eventId, eventData);
                    showNotification('Event updated successfully!', 'success');
                } else {
                    await eventsAPI.create(eventData);
                    showNotification('Event created successfully!', 'success');
                }
                setTimeout(() => {
                    window.location.href = 'events.html';
                }, 1500);
            } catch (error) {
                showNotification(error.message || `Failed to ${isEdit ? 'update' : 'create'} event`, 'error');
            }
        });

        // Load data on page load
        loadChildrenAndTeachers();
    </script>
</body>
</html>

