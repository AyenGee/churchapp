<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Record Sunday - Sunday School Records</title>
    <link rel="stylesheet" href="../css/styles.css">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body style="background: linear-gradient(to bottom, #f8fafc 0%, #f1f5f9 100%); min-height: 100vh;">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center h-16">
                <a href="../index.html" class="mr-4 hover:opacity-80 transition">‚Üê Back</a>
                <h1 class="text-xl font-bold flex items-center gap-2 text-white">
                    <span>üìù</span> Record Sunday
                </h1>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <form id="sundayRecordForm" class="card space-y-8 shadow-xl">
            <!-- Date & Class -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                    <input type="date" id="date" name="date" value="" required
                        class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Class *</label>
                    <input type="text" id="class" name="class" required placeholder="e.g., Ages 3-5, Ages 6-8"
                        class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>

            <!-- Teachers -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Teachers</label>
                <div id="teachersList" class="space-y-2 max-h-40 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                    <!-- Teachers checkboxes will be loaded here -->
                </div>
                <button type="button" onclick="window.location.href='add-teacher.html'" 
                    class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add New Teacher</button>
            </div>

            <!-- Children Attendance -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Children Present *</label>
                <input type="text" id="childSearch" placeholder="Search children..." 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    oninput="filterChildren(this.value)">
                <div id="childrenList" class="space-y-2 max-h-60 overflow-y-auto border border-gray-300 rounded-lg p-3 bg-gray-50">
                    <!-- Children checkboxes will be loaded here -->
                </div>
                <button type="button" onclick="window.location.href='add-child.html'" 
                    class="mt-2 text-sm text-blue-600 hover:text-blue-800">+ Add New Child</button>
            </div>

            <!-- Lesson -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-6 text-gray-900">Lesson Information</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Title</label>
                        <input type="text" id="lessonTitle" name="lessonTitle" placeholder="e.g., The Good Samaritan"
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Bible Verses (one per line)</label>
                        <textarea id="bibleVerses" name="bibleVerses" rows="3" placeholder="Luke 10:25-37&#10;John 3:16"
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Lesson Notes</label>
                        <textarea id="lessonNotes" name="lessonNotes" rows="4" placeholder="What was discussed, activities, key points..."
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                </div>
            </div>

            <!-- Offering -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-6 text-gray-900">Offering</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Amount ($)</label>
                        <input type="number" id="offeringAmount" name="offeringAmount" min="0" step="0.01" placeholder="0.00"
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Purpose</label>
                        <input type="text" id="offeringPurpose" name="offeringPurpose" placeholder="e.g., Mission fund"
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                </div>
            </div>

            <!-- Special Notes -->
            <div class="border-t border-gray-200 pt-6">
                <h3 class="text-xl font-semibold mb-6 text-gray-900">Additional Information</h3>
                <div class="space-y-4">
                    <div class="flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="isSpecialSunday" name="isSpecialSunday" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Special Sunday</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="isCombinedClass" name="isCombinedClass" class="mr-2">
                            <span class="text-sm font-medium text-gray-700">Combined Classes</span>
                        </label>
                    </div>
                    <div id="specialThemeDiv" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Special Theme</label>
                        <input type="text" id="specialTheme" name="specialTheme" placeholder="e.g., Easter, Christmas"
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Announcements</label>
                        <textarea id="announcements" name="announcements" rows="3" placeholder="Any announcements made..."
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Special Notes</label>
                        <textarea id="specialNotes" name="specialNotes" rows="3" placeholder="Anything else to note..."
                            class="form-input w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"></textarea>
                    </div>
                </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-200">
                <button type="submit" 
                    class="btn btn-primary flex-1 px-6 py-3 text-base font-medium shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
                    Save Record
                </button>
                <button type="button" onclick="window.location.href='../index.html'"
                    class="btn btn-secondary flex-1 px-6 py-3 text-base font-medium">
                    Cancel
                </button>
            </div>
        </form>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        let allChildren = [];
        let allTeachers = [];

        // Set today's date as default
        document.getElementById('date').value = getTodayDate();

        // Toggle special theme field
        document.getElementById('isSpecialSunday').addEventListener('change', function() {
            document.getElementById('specialThemeDiv').classList.toggle('hidden', !this.checked);
        });

        // Load children and teachers
        async function loadChildrenAndTeachers() {
            try {
                [allChildren, allTeachers] = await Promise.all([
                    childrenAPI.getAll('?active=true'),
                    teachersAPI.getAll('?active=true')
                ]);

                renderChildren(allChildren);
                renderTeachers(allTeachers);
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Failed to load children and teachers', 'error');
            }
        }

        function renderChildren(children) {
            const container = document.getElementById('childrenList');
            if (children.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No children found. Add a child first.</p>';
                return;
            }
            container.innerHTML = children.map(child => `
                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" name="childrenPresent" value="${child._id}" class="mr-2">
                    <span class="text-sm">${child.name} (${child.class})</span>
                </label>
            `).join('');
        }

        function renderTeachers(teachers) {
            const container = document.getElementById('teachersList');
            if (teachers.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No teachers found. Add a teacher first.</p>';
                return;
            }
            container.innerHTML = teachers.map(teacher => `
                <label class="flex items-center p-2 hover:bg-gray-50 rounded cursor-pointer">
                    <input type="checkbox" name="teachers" value="${teacher._id}" class="mr-2">
                    <span class="text-sm">${teacher.name} (${teacher.role})</span>
                </label>
            `).join('');
        }

        function filterChildren(searchTerm) {
            const filtered = allChildren.filter(child => 
                child.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                child.class.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderChildren(filtered);
        }

        // Handle form submission
        document.getElementById('sundayRecordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const childrenCheckboxes = document.querySelectorAll('input[name="childrenPresent"]:checked');
            const teachersCheckboxes = document.querySelectorAll('input[name="teachers"]:checked');

            // Get bible verses as array
            const versesText = document.getElementById('bibleVerses').value;
            const bibleVerses = versesText.split('\n').filter(v => v.trim());

            const recordData = {
                date: formData.get('date'),
                class: formData.get('class'),
                childrenPresent: Array.from(childrenCheckboxes).map(cb => cb.value),
                teachers: Array.from(teachersCheckboxes).map(cb => cb.value),
                lessonTitle: formData.get('lessonTitle') || undefined,
                bibleVerses: bibleVerses.length > 0 ? bibleVerses : undefined,
                lessonNotes: formData.get('lessonNotes') || undefined,
                offeringAmount: formData.get('offeringAmount') ? parseFloat(formData.get('offeringAmount')) : 0,
                offeringPurpose: formData.get('offeringPurpose') || undefined,
                announcements: formData.get('announcements') || undefined,
                specialNotes: formData.get('specialNotes') || undefined,
                isSpecialSunday: document.getElementById('isSpecialSunday').checked,
                isCombinedClass: document.getElementById('isCombinedClass').checked,
                specialTheme: formData.get('specialTheme') || undefined
            };

            try {
                await sundayRecordsAPI.create(recordData);
                showNotification('Sunday record saved successfully!', 'success');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 1500);
            } catch (error) {
                showNotification(error.message || 'Failed to save record', 'error');
            }
        });

        // Load data on page load
        loadChildrenAndTeachers();
    </script>
</body>
</html>

